class AcGameMenu{constructor(t,s){this.root=t,this.AcWingOS=s,this.$menu=$('\n<div class="ac-game-menu">\n    <div class="title">Let\'s play some DOTA</div>    \n    <div class="ac-game-menu-field">\n        <div class="ac-game-menu-field-item ac-game-menu-field-item-single-mode">\n            单人模式\n        </div>\n        <br>\n        <div class="ac-game-menu-field-item ac-game-menu-field-item-multi-mode">\n            多人模式\n        </div>\n        <br>\n        <div class="ac-game-menu-field-item ac-game-menu-field-item-settings">\n            退出\n        </div>\n        \n    </div>\n</div>\n'),this.$menu.hide(),this.root.$ac_game.append(this.$menu),this.$single_mode=this.$menu.find(".ac-game-menu-field-item-single-mode"),this.$multi_mode=this.$menu.find(".ac-game-menu-field-item-multi-mode"),this.$settings=this.$menu.find(".ac-game-menu-field-item-settings"),this.$playdota=this.$menu.find("title"),this.start()}start(){this.add_listening_events()}add_listening_events(){let t=this;this.$single_mode.click((function(){t.hide(),t.root.playground.show("single mode")})),this.$multi_mode.click((function(){t.hide(),t.root.playground.show("multi mode")})),this.$settings.click((function(){console.log("click settings"),t.root.settings.logout_on_remote()}))}show(){this.$menu.show()}hide(){this.$menu.hide()}}let last_timestamp,AC_GAME_OBJECTS=[];class AcGameObject{constructor(){AC_GAME_OBJECTS.push(this),this.had_called_start=!1,this.timedelta=0,this.uuid=this.create_uuid()}create_uuid(){let t="";for(let s=0;s<8;s++){t+=parseInt(Math.floor(10*Math.random()))}return t}start(){}update(){}late_update(){}on_destroy(){}resize(){this.ctx.canvas.width=this.playground.width,this.ctx.canvas.height=this.playground.height}destroy(){this.on_destroy();for(let t=0;t<AC_GAME_OBJECTS.length;t++)if(AC_GAME_OBJECTS[t]===this){AC_GAME_OBJECTS.splice(t,1);break}}}let AC_GAME_ANIMATION=function(t){for(let s=0;s<AC_GAME_OBJECTS.length;s++){let i=AC_GAME_OBJECTS[s];i.had_called_start?(i.timedelta=t-last_timestamp,i.update()):(i.had_called_start=!0,i.start());for(let t=0;t<AC_GAME_OBJECTS.length;t++){AC_GAME_OBJECTS[t].late_update()}}last_timestamp=t,requestAnimationFrame(AC_GAME_ANIMATION)};requestAnimationFrame(AC_GAME_ANIMATION);class ChatField{constructor(t){this.playground=t,this.$history=$('<div class="ac-game-chat-field-history"></div>'),this.$input=$('<input class="ac-game-chat-field-input"></input>'),this.$history.hide(),this.$input.hide(),this.playground.$playground.append(this.$history),this.playground.$playground.append(this.$input),this.start()}start(){this.add_listening_events()}add_listening_events(){let t=this;this.$input.keydown((function(s){if(27==s.which)return t.hide_input(),t.hide_history(),!1;if(13==s.which){let s=t.playground.root.settings.username,i=t.$input.val();return i&&(t.$input.val(""),t.add_message(s,i),t.playground.mps.send_message(i)),t.show_history(),!1}}))}rend_message(t){return $(`<div>${t}</div>`)}add_message(t,s){let i=`[${t}]: ${s}`;this.$history.append(this.rend_message(i)),this.$history.scrollTop(this.$history[0].scrollHeight)}show_history(){this.$history.fadeIn()}show_input(){this.show_history(),this.$input.show(),this.$input.focus()}hide_history(){this.$history.hide()}hide_input(){this.$input.hide(),this.playground.game_map.$canvas.focus()}}class GameMap extends AcGameObject{constructor(t){super(),this.playground=t,this.$canvas=$("<canvas tabindex=0> </canvas>"),this.ctx=this.$canvas[0].getContext("2d"),this.ctx.canvas.width=this.playground.width,this.ctx.canvas.height=this.playground.height,this.playground.$playground.append(this.$canvas)}start(){this.$canvas.focus()}update(){this.render()}resize(){this.ctx.canvas.width=this.playground.width,this.ctx.canvas.height=this.playground.height,this.ctx.fillStyle="rgba(0, 0, 0, 1)",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}render(){this.ctx.fillStyle="rgba(0, 0, 0, 0.75)",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}}class NoticeBoard extends AcGameObject{constructor(t){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.text="已就绪：0人"}start(){}update(){this.render()}write(t){this.text=t}render(){this.ctx.font="20px serif",this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.fillText(this.text,this.playground.width/2,20)}}class Particle extends AcGameObject{constructor(t,s,i,e,a,h,n,l,r){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.x=s,this.y=i,this.radius=e,this.vx=a,this.vy=h,this.speed=n,this.color=l,this.move_length=r,this.friction=.9,this.eps=1}start(){}update(){if(this.move_length<this.eps||this.speed<.5*this.eps)return this.destroy(),!1;{let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.speed*=this.friction,this.move_length-=t}this.render()}render(){let t=this.playground.scale;this.ctx.beginPath(),this.ctx.arc(this.x*t,this.y*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()}}class Player extends AcGameObject{constructor(t,s,i,e,a,h,n,l,r){super(),this.x=s,this.y=i,this.playground=t,this.ctx=this.playground.game_map.ctx,this.radius=e,this.color=a,this.speed=h,this.character=n,this.eps=.01,this.vx=0,this.vy=0,this.damage_x=0,this.damage_y=0,this.damage_speed=0,this.friction=.9,this.is_alive=!0,this.move_length=0,this.cur_skill=null,this.spent_time=0,this.username=l,this.photo=r,this.balls=[],"me"!=this.character&&"enemy"!=this.character||(this.img=new Image,this.img.src=this.photo),"me"==this.character&&(this.fireball_cd=5,this.thunderball_cd=5,this.iceball_cd=5,this.fireball_img=new Image,this.fireball_img.src="https://adguycn990-typoraimage.oss-cn-hangzhou.aliyuncs.com/typora-img/202207271938643.png",this.iceball_img=new Image,this.iceball_img.src="https://adguycn990-typoraimage.oss-cn-hangzhou.aliyuncs.com/typora-img/202207271938977.png",this.thunderball_img=new Image,this.thunderball_img.src="https://adguycn990-typoraimage.oss-cn-hangzhou.aliyuncs.com/typora-img/202207271938023.png")}start(){if(this.playground.player_cnt++,this.playground.notice_board.write("已就绪："+this.playground.player_cnt+"人"),this.playground.player_cnt>=2&&(this.playground.state="fighting",this.playground.notice_board.write("Fighting!")),"me"==this.character)this.add_listenting_events();else if("robot"==this.character){let t=Math.random()*this.playground.width/this.playground.scale,s=Math.random()*this.playground.height/this.playground.scale;this.move_to(t,s)}}add_listenting_events(){let t=this;this.playground.game_map.$canvas.on("contextmenu",(function(){return!1})),this.playground.game_map.$canvas.mousedown((function(s){if("fighting"!=t.playground.state)return!0;const i=t.ctx.canvas.getBoundingClientRect();let e=(s.clientX-i.left)/t.playground.scale,a=(s.clientY-i.top)/t.playground.scale;if(!t.is_alive)return!1;if(3==s.which)t.move_to(e,a),"multi mode"==t.playground.mode&&t.playground.mps.send_move_to(e,a);else if(1==s.which){if("fireball"==t.cur_skill&&t.fireball_cd<t.eps){let s=t.shoot_fireball(e,a);"multi mode"==t.playground.mode&&t.playground.mps.send_shootfireball(e,a,s.uuid)}else if("iceball"==t.cur_skill&&t.iceball_cd<t.eps){let s=t.shoot_iceball(e,a);"multi mode"==t.playground.mode&&t.playground.mps.send_shooticeball(e,a,s.uuid)}else if("thunderball"==t.cur_skill&&t.thunderball_cd<t.eps){let s=t.shoot_thunderball(e,a);"multi mode"==t.playground.mode&&t.playground.mps.send_shootthunderball(e,a,s.uuid)}t.cur_skill=null}})),this.playground.game_map.$canvas.keydown((function(s){if(13==s.which){if("multi mode"==t.playground.mode)return t.playground.chat_field.show_input(),!1}else 27==s.which?"multi mode"==t.playground.mode&&t.playground.chat_field.hide_input():69===s.which&&t.fireball_cd<t.eps&&"fighting"==t.playground.state?t.cur_skill="fireball":81==s.which&&t.iceball_cd<t.eps&&"fighting"==t.playground.state?t.cur_skill="iceball":87==s.which&&t.thunderball_cd<t.eps&&"fighting"==t.playground.state&&(t.cur_skill="thunderball")}))}shoot_fireball(t,s){if(!this.is_alive)return!1;let i=this.x,e=this.y,a=Math.atan2(s-e,t-i),h=Math.cos(a),n=Math.sin(a),l=new FireBall(this.playground,i,e,h,n,.01,"orange",.5,this,1,.01);return this.balls.push(l),this.fireball_cd=5,l}destroy_ball(t){for(let s=0;s<this.balls.length;s++){let i=this.balls[s];if(i.uuid==t){i.destroy();break}}}on_destroy(){"me"==this.character&&"fighting"==this.playground.state&&(this.playground.state="over",this.playground.score_board.lose());for(let t=0;t<this.playground.players.length;t++)if(this.playground.players[t]==this){this.playground.players.splice(t,1);break}}shoot_iceball(t,s){if(!this.is_alive)return!1;let i=this.x,e=this.y,a=Math.atan2(s-e,t-i),h=Math.cos(a),n=Math.sin(a),l=new IceBall(this.playground,i,e,h,n,.02,"skyblue",.3,this,1,.0075);return this.balls.push(l),this.iceball_cd=5,l}shoot_thunderball(t,s){if(!this.is_alive)return!1;let i=this.x,e=this.y,a=Math.atan2(s-e,t-i),h=Math.cos(a),n=Math.sin(a),l=new ThunderBall(this.playground,i,e,h,n,.01,"purple",.8,this,1,.005);return this.balls.push(l),this.thunderball_cd=5,l}get_dis(t,s,i,e){let a=t-i,h=s-e;return Math.sqrt(a*a+h*h)}move_to(t,s){this.move_length=this.get_dis(this.x,this.y,t,s);let i=Math.atan2(s-this.y,t-this.x);this.vx=Math.cos(i),this.vy=Math.sin(i)}is_attacked(t,s,i,e){for(let t=0;t<20+5*Math.random();t++){let t=this.x,s=this.y,i=this.radius*Math.random()*.1,e=2*Math.PI*Math.random(),a=Math.cos(e),h=Math.sin(e),n=this.color,l=7*this.speed,r=this.radius*Math.random()*175;new Particle(this.playground,t,s,i,a,h,l,n,r)}if(this.radius-=s,this.radius<this.eps)return this.is_alive=!1,this.destroy(),"me"==this.character&&(this.playground.state="lose",this.playground.notice_board.write("哥哥你这么菜你女朋友知道了不会生气吧")),!1;this.damage_x=Math.cos(t),this.damage_y=Math.sin(t),this.damage_speed=i,this.speed*=e}receive_attack(t,s,i,e,a,h,n,l){this.x=t,this.y=s,l.destroy_ball(n),this.is_attacked(i,e,a,h)}update(){this.spent_time+=this.timedelta/1e3,this.update_win(),this.update_move(),"me"==this.character&&"fighting"==this.playground.state&&this.update_cd(),this.render()}update_win(){"fighting"==this.playground.state&&"me"==this.character&&1==this.playground.players.length&&(this.playground.state="over",this.playground.notice_board.write("我们是冠军咚咚咚咚!"),this.playground.score_board.win())}update_cd(){this.fireball_cd=Math.max(0,this.fireball_cd-this.timedelta/1e3),this.iceball_cd=Math.max(0,this.iceball_cd-this.timedelta/1e3),this.thunderball_cd=Math.max(0,this.thunderball_cd-this.timedelta/1e3)}update_move(){if(Math.random()<1/300&&"robot"==this.character&&this.spent_time>5){let t=this.playground.players[0],s=Math.floor(3*Math.random());0==s?this.shoot_fireball(t.x,t.y):1==s?this.shoot_iceball(t.x,t.y):2==s&&this.shoot_thunderball(t.x,t.y)}if(this.damage_speed>this.eps)this.vx=0,this.vy=0,this.move_length=0,this.x+=this.damage_speed*this.damage_x*this.timedelta/1e3,this.y+=this.damage_speed*this.damage_y*this.timedelta/1e3,this.damage_speed*=this.friction,this.damage_speed<.3*this.speed&&(this.damage_speed=0);else if(this.move_length<this.eps){if(this.vx=0,this.vy=0,this.move_length=0,"robot"==this.character){let t=Math.random()*this.playground.width/this.playground.scale,s=Math.random()*this.playground.height/this.playground.scale;this.move_to(t,s)}}else{let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=t*this.vx,this.y+=t*this.vy,this.move_length-=t}}render(){let t=this.playground.scale;"me"==this.character||"enemy"==this.character?(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(this.x*t,this.y*t,this.radius*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.img,(this.x-this.radius)*t,(this.y-this.radius)*t,2*this.radius*t,2*this.radius*t),this.ctx.restore()):(this.ctx.beginPath(),this.ctx.arc(this.x*t,this.y*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()),"me"==this.character&&"fighting"==this.playground.state&&(this.render_fireball_cd(),this.render_iceball_cd(),this.render_thunderball_cd())}render_fireball_cd(){let t=this.playground.scale,s=1.62,i=.9,e=.04;this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(s*t,i*t,e*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.fireball_img,(s-e)*t,(i-e)*t,2*e*t,2*e*t),this.ctx.restore(),this.fireball_cd>0&&(this.ctx.beginPath(),this.ctx.moveTo(s*t,i*t),this.ctx.arc(s*t,i*t,e*t,0-Math.PI/2,2*Math.PI*(1-this.fireball_cd/5)-Math.PI/2,!0),this.ctx.lineTo(s*t,i*t),this.ctx.fillStyle="rgba(0, 0, 255, 0.6)",this.ctx.fill())}render_iceball_cd(){let t=this.playground.scale,s=1.38,i=.9,e=.04;this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(s*t,i*t,e*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.iceball_img,(s-e)*t,(i-e)*t,2*e*t,2*e*t),this.ctx.restore(),this.iceball_cd>0&&(this.ctx.beginPath(),this.ctx.moveTo(s*t,i*t),this.ctx.arc(s*t,i*t,e*t,0-Math.PI/2,2*Math.PI*(1-this.iceball_cd/5)-Math.PI/2,!0),this.ctx.lineTo(s*t,i*t),this.ctx.fillStyle="rgba(0, 0, 255, 0.6)",this.ctx.fill())}render_thunderball_cd(){let t=this.playground.scale,s=1.5,i=.9,e=.04;this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(s*t,i*t,e*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.thunderball_img,(s-e)*t,(i-e)*t,2*e*t,2*e*t),this.ctx.restore(),this.thunderball_cd>0&&(this.ctx.beginPath(),this.ctx.moveTo(s*t,i*t),this.ctx.arc(s*t,i*t,e*t,0-Math.PI/2,2*Math.PI*(1-this.thunderball_cd/5)-Math.PI/2,!0),this.ctx.lineTo(s*t,i*t),this.ctx.fillStyle="rgba(0, 0, 255, 0.6)",this.ctx.fill())}}class ScoreBoard extends AcGameObject{constructor(t){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.state=null,this.win_image=new Image,this.win_image.src="https://cdn.acwing.com/media/article/image/2021/12/17/1_8f58341a5e-win.png",this.lose_image=new Image,this.lose_image.src="https://cdn.acwing.com/media/article/image/2021/12/17/1_9254b5f95e-lose.png"}add_listening_events(){let t=this;this.playground.game_map.$canvas.on("click",(function(){t.playground.hide(),t.playground.root.menu.show()}))}win(){this.state="win";let t=this;setTimeout((function(){t.add_listening_events()}),1e3)}lose(){this.state="lose";let t=this;setTimeout((function(){t.add_listening_events()}),1e3)}late_update(){this.render()}start(){}render(){let t=this.playground.height/2;"win"==this.state?this.ctx.drawImage(this.win_image,this.playground.width/2-t/2,this.playground.height/2-t/2,t,t):"lose"==this.state&&this.ctx.drawImage(this.lose_image,this.playground.width/2-t/2,this.playground.height/2-t/2,t,t)}}class FireBall extends AcGameObject{constructor(t,s,i,e,a,h,n,l,r,o,d){super(),this.playground=t,this.x=s,this.y=i,this.ctx=this.playground.game_map.ctx,this.vx=e,this.vy=a,this.eps=.01,this.radius=h,this.color=n,this.speed=l,this.player=r,this.move_length=o,this.damage=d,this.damage_speed=100*this.damage,this.is_speed_up=1.1}start(){}update_move(){let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=t*this.vx,this.y+=t*this.vy,this.move_length-=t}update_attack(){for(let t=0;t<this.playground.players.length;t++){let s=this.playground.players[t];this.player!=s&&this.is_collision(s)&&this.attack(s)}}update(){if(this.move_length<this.eps)return this.destroy(),!1;this.update_move(),"enemy"!=this.player.character&&this.update_attack(),this.render()}get_dist(t,s,i,e){let a=t-i,h=s-e;return Math.sqrt(a*a+h*h)}attack(t){let s=Math.atan2(t.y-this.y,t.x-this.x);t.is_attacked(s,this.damage,this.damage_speed,this.is_speed_up),"multi mode"==this.playground.mode&&this.playground.mps.send_attack(t.uuid,t.x,t.y,s,this.damage,this.damage_speed,this.is_speed_up,this.uuid),this.destroy()}is_collision(t){return this.get_dist(this.x,this.y,t.x,t.y)<this.radius+t.radius}on_destroy(){let t=this.player.balls;for(let s=0;s<t.length;s++){if(this==t[s]){t.splice(s,1);break}}}render(){let t=this.playground.scale;this.ctx.beginPath(),this.ctx.arc(this.x*t,this.y*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()}}class IceBall extends AcGameObject{constructor(t,s,i,e,a,h,n,l,r,o,d){super(),this.playground=t,this.x=s,this.y=i,this.ctx=this.playground.game_map.ctx,this.vx=e,this.vy=a,this.eps=.01,this.radius=h,this.color=n,this.speed=l,this.player=r,this.move_length=o,this.damage=d,this.damage_speed=200*this.damage,this.is_speed_up=.75}start(){}update_move(){let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=t*this.vx,this.y+=t*this.vy,this.move_length-=t}update_attack(){for(let t=0;t<this.playground.players.length;t++){let s=this.playground.players[t];this.player!=s&&this.is_collision(s)&&this.attack(s)}}update(){if(this.move_length<this.eps)return this.destroy(),!1;this.update_move(),"enemy"!=this.player.character&&this.update_attack(),this.render()}get_dist(t,s,i,e){let a=t-i,h=s-e;return Math.sqrt(a*a+h*h)}attack(t){let s=Math.atan2(t.y-this.y,t.x-this.x);t.is_attacked(s,this.damage,this.damage_speed,this.is_speed_up),"multi mode"==this.playground.mode&&this.playground.mps.send_attack(t.uuid,t.x,t.y,s,this.damage,this.damage_speed,this.is_speed_up,this.uuid),this.destroy()}is_collision(t){return this.get_dist(this.x,this.y,t.x,t.y)<this.radius+t.radius}on_destroy(){let t=this.player.balls;for(let s=0;s<t.length;s++){if(this==t[s]){t.splice(s,1);break}}}render(){let t=this.playground.scale;this.ctx.beginPath(),this.ctx.arc(this.x*t,this.y*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()}}class ThunderBall extends AcGameObject{constructor(t,s,i,e,a,h,n,l,r,o,d){super(),this.playground=t,this.x=s,this.y=i,this.ctx=this.playground.game_map.ctx,this.vx=e,this.vy=a,this.eps=.01,this.radius=h,this.color=n,this.speed=l,this.player=r,this.move_length=o,this.damage=d,this.damage_speed=this.damage,this.is_speed_up=1}start(){}update_move(){let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=t*this.vx,this.y+=t*this.vy,this.move_length-=t}update_attack(){for(let t=0;t<this.playground.players.length;t++){let s=this.playground.players[t];this.player!=s&&this.is_collision(s)&&this.attack(s)}}update(){if(this.move_length<this.eps)return this.destroy(),!1;this.update_move(),"enemy"!=this.player.character&&this.update_attack(),this.render()}get_dist(t,s,i,e){let a=t-i,h=s-e;return Math.sqrt(a*a+h*h)}attack(t){let s=Math.atan2(t.y-this.y,t.x-this.x);t.is_attacked(s,this.damage,this.damage_speed,this.is_speed_up),"multi mode"==this.playground.mode&&this.playground.mps.send_attack(t.uuid,t.x,t.y,s,this.damage,this.damage_speed,this.is_speed_up,this.uuid),this.destroy()}on_destroy(){let t=this.player.balls;for(let s=0;s<t.length;s++){if(this==t[s]){t.splice(s,1);break}}}is_collision(t){return this.get_dist(this.x,this.y,t.x,t.y)<this.radius+t.radius}render(){let t=this.playground.scale;this.ctx.beginPath(),this.ctx.arc(this.x*t,this.y*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()}}class MultiPlayerSocket{constructor(t){this.playground=t,this.ws=new WebSocket("wss://app2796.acapp.acwing.com.cn/wss/multiplayer/"),this.start()}start(){this.receive()}receive(){let t=this;this.ws.onmessage=function(s){let i=JSON.parse(s.data),e=i.uuid;if(e==t.uuid)return!1;let a=i.event;"create_player"==a?t.receive_create_player(e,i.username,i.photo):"move_to"==a?t.receive_move_to(e,i.tx,i.ty):"shoot_fireball"==a?t.receive_shootfireball(e,i.tx,i.ty,i.ball_uuid):"shoot_iceball"==a?t.receive_shooticeball(e,i.tx,i.ty,i.ball_uuid):"shoot_thunderball"==a?t.receive_shootthunderball(e,i.tx,i.ty,i.ball_uuid):"attack"==a?t.receive_attack(e,i.attackee_uuid,i.x,i.y,i.angle,i.damage,i.damage_speed,i.is_speed_up,i.ball_uuid):"message"==a&&t.receive_message(e,i.text)}}get_player(t){let s=this.playground.players;for(let i=0;i<s.length;i++){let e=s[i];if(e.uuid==t)return e}return null}send_create_player(t,s){this.ws.send(JSON.stringify({event:"create_player",uuid:this.uuid,username:t,photo:s}))}send_move_to(t,s){this.ws.send(JSON.stringify({event:"move_to",uuid:this.uuid,tx:t,ty:s}))}send_shootfireball(t,s,i){this.ws.send(JSON.stringify({event:"shoot_fireball",uuid:this.uuid,tx:t,ty:s,ball_uuid:i}))}send_shooticeball(t,s,i){this.ws.send(JSON.stringify({event:"shoot_iceball",uuid:this.uuid,tx:t,ty:s,ball_uuid:i}))}send_shootthunderball(t,s,i){this.ws.send(JSON.stringify({event:"shoot_thunderball",uuid:this.uuid,tx:t,ty:s,ball_uuid:i}))}send_attack(t,s,i,e,a,h,n,l){this.ws.send(JSON.stringify({event:"attack",uuid:this.uuid,attackee_uuid:t,x:s,y:i,angle:e,damage:a,damage_speed:h,is_speed_up:n,ball_uuid:l}))}send_message(t){this.ws.send(JSON.stringify({event:"message",uuid:this.uuid,text:t}))}receive_create_player(t,s,i){let e=new Player(this.playground,this.playground.width/2/this.playground.scale,.5,.05,"white",.25,"enemy",s,i);e.uuid=t,this.playground.players.push(e)}receive_move_to(t,s,i){let e=this.get_player(t);e&&e.move_to(s,i)}receive_shootfireball(t,s,i,e){let a=this.get_player(t);if(a){a.shoot_fireball(s,i).uuid=e}}receive_shooticeball(t,s,i,e){let a=this.get_player(t);if(a){a.shoot_iceball(s,i).uuid=e}}receive_shootthunderball(t,s,i,e){let a=this.get_player(t);if(a){a.shoot_thunderball(s,i).uuid=e}}receive_attack(t,s,i,e,a,h,n,l,r){let o=this.get_player(t),d=this.get_player(s);d.is_alive&&o.is_alive&&d.receive_attack(i,e,a,h,n,l,r,o)}receive_message(t,s){let i=this.get_player(t);i.playground.chat_field.add_message(i.username,s)}}class AcGamePlayground{constructor(t){this.root=t,this.$playground=$('\n            <div class="ac-game-playground">\n        \n            </div>\n        '),this.root.$ac_game.append(this.$playground),this.hide(),this.start()}get_random_color(){let t=["green","gray","blue","red","pink","yellow","brown"];return t[Math.floor(Math.random()*t.length)]}start(){let t=this;$(window).resize((function(){t.resize()}))}resize(){this.width=this.$playground.width(),this.height=this.$playground.height();let t=Math.min(this.width/16,this.height/9);this.width=16*t,this.height=9*t,this.scale=this.height,this.game_map&&this.game_map.resize()}show(t){let s=this;if(this.$playground.show(),this.state="waiting",this.mode=t,this.height=this.$playground.height(),this.width=this.$playground.width(),this.player_cnt=0,this.game_map=new GameMap(this),this.notice_board=new NoticeBoard(this),this.score_board=new ScoreBoard(this),this.resize(),this.players=[],this.players.push(new Player(this,this.width/2/this.scale,.5,.05,"white",.25,"me",this.root.settings.username,this.root.settings.photo)),"single mode"==t)for(let t=0;t<6;t++)this.players.push(new Player(this,this.width/2/this.scale,.5,.05,this.get_random_color(),.25,"robot"));else"multi mode"==t&&(this.chat_field=new ChatField(this),this.mps=new MultiPlayerSocket(this),this.mps.uuid=this.players[0].uuid,this.mps.ws.onopen=function(){s.mps.send_create_player(s.root.settings.username,s.root.settings.photo)})}hide(){for(;this.players&&this.players.length>0;)this.players[0].destroy();this.game_map&&(this.game_map.destroy(),this.game_map=null),this.notice_board&&(this.notice_board.destroy(),this.notice_board=null),this.score_board&&(this.score_board.destroy(),this.score_board=null),this.$playground.empty(),this.$playground.hide()}}class Settings{constructor(t){this.root=t,this.platform="WEB",this.username="",this.photo="",this.root.AcWingOS&&(this.platform="ACAPP"),this.$settings=$('\n        <div class="ac-game-settings">\n            <div class="ac-game-settings-register">\n                <div class="ac-game-settings-title"> \x3c!--标题--\x3e\n                    注册\n                </div>\n\n                <div class="ac-game-settings-username"> \x3c!--输入用户名--\x3e\n                    <div class="ac-game-settings-item">\n                        <input type="text" placeholder="用户名"> \n                    </div>\n                </div>\n\n                <div class="ac-game-settings-password ac-game-settings-password-first"> \x3c!--输入密码--\x3e\n                    <div class="ac-game-settings-item">\n                        <input type="password" placeholder="密码"> \n                    </div>\n                </div>\n\n                <div class="ac-game-settings-password ac-game-settings-password-second"> \x3c!--再次输入密码--\x3e\n                    <div class="ac-game-settings-item">\n                        <input type="password" placeholder="确认密码"> \n                    </div>\n                </div>\n\n                <div class="ac-game-settings-submit"> \x3c!--确认按钮--\x3e\n                    <div class="ac-game-settings-item">\n                        <button>注册</button> \n                    </div>\n                </div>\n\n                <div class="ac-game-settings-errormessage"> \x3c!--报错信息栏--\x3e\n                    \n                </div>\n\n                <div class="ac-game-settings-option"> \x3c!--登录,点击跳转登录页面--\x3e\n                    登录\n                </div>\n                <br>\n                <div class="ac-game-settings-acwing"> \x3c!--acwing登录--\x3e\n                    <img src="https://app2796.acapp.acwing.com.cn/static/image/settings/acwing_logo.png" width="30"> <br>\n                    <div>AcWing一键登录</div>\n                </div>\n            </div>\n\n            <div class="ac-game-settings-login">\n                <div class="ac-game-settings-title"> \x3c!--标题--\x3e\n                    登录\n                </div>\n\n                <div class="ac-game-settings-username"> \x3c!--输入用户名--\x3e\n                    <div class="ac-game-settings-item">\n                        <input type="text" placeholder="用户名"> \n                    </div>\n                </div>\n\n                <div class="ac-game-settings-password"> \x3c!--输入密码--\x3e\n                    <div class="ac-game-settings-item">\n                        <input type="password" placeholder="密码"> \n                    </div>\n                </div>\n\n                <div class="ac-game-settings-submit"> \x3c!--确认按钮--\x3e\n                    <div class="ac-game-settings-item">\n                        <button>登录</button> \n                    </div>\n                </div>\n\n                <div class="ac-game-settings-errormessage"> \x3c!--报错信息栏--\x3e\n                    \n                </div>\n\n                <div class="ac-game-settings-option"> \x3c!--注册--\x3e\n                    注册\n                </div>\n                <br>\n                <div class="ac-game-settings-acwing"> \x3c!--acwing登录--\x3e\n                    <img src="https://app2796.acapp.acwing.com.cn/static/image/settings/acwing_logo.png" width="30"> <br>\n                    <div>AcWing一键登录</div>\n                </div>\n\n            </div>\n        </div>\n        '),this.$login=this.$settings.find(".ac-game-settings-login"),this.$login_username=this.$login.find(".ac-game-settings-username input"),this.$login_password=this.$login.find(".ac-game-settings-password input"),this.$login_submit=this.$login.find(".ac-game-settings-submit button"),this.$login_error_message=this.$login.find(".ac-game-settings-errormessage"),this.$login_register=this.$login.find(".ac-game-settings-option"),this.$acwing_login=this.$login.find(".ac-game-settings-acwing img"),this.$login.hide(),this.$register=this.$settings.find(".ac-game-settings-register"),this.$register_username=this.$register.find(".ac-game-settings-username input"),this.$register_password=this.$register.find(".ac-game-settings-password-first input"),this.$register_password_confirm=this.$register.find(".ac-game-settings-password-second input"),this.$register_submit=this.$register.find(".ac-game-settings-submit button"),this.$register_error_message=this.$register.find(".ac-game-settings-errormessage"),this.$register_login=this.$register.find(".ac-game-settings-option"),this.$register.hide(),this.root.$ac_game.append(this.$settings),this.start()}start(){"WEB"==this.platform?(this.getinfo_web(),this.add_listening_events()):"ACAPP"==this.platform&&this.getinfo_acapp()}getinfo_web(){let t=this;$.ajax({url:"https://app2796.acapp.acwing.com.cn/settings/getinfo/",type:"GET",data:{platform:t.platform},success:function(s){console.log(s),"success"==s.result?(t.photo=s.photo,t.username=s.username,t.hide(),t.root.menu.show()):t.login()}})}acapp_login(t,s,i,e){let a=this;this.root.AcWingOS.api.oauth2.authorize(t,s,i,e,(function(t){console.log(t),"success"===t.result&&(a.username=t.username,a.photo=t.photo,a.hide(),a.root.menu.show())}))}getinfo_acapp(){let t=this;$.ajax({url:"https://app2796.acapp.acwing.com.cn/settings/acwing/acapp/apply_code/",type:"GET",success(s){"success"==s.result&&t.acapp_login(s.appid,s.redirect_uri,s.scope,s.state)}})}add_listening_events(){this.add_listening_events_login(),this.add_listening_events_register(),this.add_listening_events_acwing()}add_listening_events_acwing(){let t=this;this.$acwing_login.click((function(){t.acwing_login()}))}acwing_login(){$.ajax({url:"https://app2796.acapp.acwing.com.cn/settings/acwing/web/apply_code",type:"GET",success:function(t){console.log(t),"success"==t.result&&window.location.replace(t.apply_code_url)}})}add_listening_events_login(){let t=this;this.$login_register.click((function(){t.register()})),this.$login_submit.click((function(){t.login_on_remote()}))}login_on_remote(){let t=this,s=this.$login_username.val(),i=this.$login_password.val();this.$login_error_message.empty(),$.ajax({url:"https://app2796.acapp.acwing.com.cn/settings/login/",type:"GET",data:{username:s,password:i},success:function(s){console.log(s),"success"==s.result?location.reload():t.$login_error_message.html(s.result)}})}logout_on_remote(){"ACAPP"==this.platform&&this.root.AcWingOS.api.window.close(),$.ajax({url:"https://app2796.acapp.acwing.com.cn/settings/logout/",type:"GET",success:function(t){console.log(t),"success"==t.result&&location.reload()}})}register_on_remote(){let t=this,s=this.$register_username.val(),i=this.$register_password.val(),e=this.$register_password_confirm.val();this.$login_error_message.empty(),$.ajax({url:"https://app2796.acapp.acwing.com.cn/settings/register/",type:"GET",data:{username:s,password:i,password_confirm:e},success:function(s){console.log(s),"success"==s.result?location.reload():t.$register_error_message.html(s.result)}})}add_listening_events_register(){let t=this;this.$register_login.click((function(){t.login()})),this.$register_submit.click((function(){t.register_on_remote()}))}hide(){this.$settings.hide()}show(){this.$settings.show()}login(){this.$register.hide(),this.$login.show()}register(){this.$login.hide(),this.$register.show()}}export class AcGame{constructor(t,s){this.id=t,this.$ac_game=$("#"+t),this.AcWingOS=s,this.settings=new Settings(this),this.menu=new AcGameMenu(this),this.playground=new AcGamePlayground(this),this.start()}start(){}}
